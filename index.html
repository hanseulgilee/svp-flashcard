<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SVP-PREP ìŠ¤ë§ˆíŠ¸ í”Œë˜ì‹œì¹´ë“œ (AI Enhanced)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script type="importmap">
      {
        "imports": {
          "@google/generative-ai": "https://esm.run/@google/generative-ai"
        }
      }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap');
        
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #f0f4f8;
        }

        /* 3D Flip Animation Styles */
        .perspective-1000 {
            perspective: 1000px;
        }
        
        .flip-card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            text-align: center;
            transition: transform 0.6s;
            transform-style: preserve-3d;
            cursor: pointer;
        }
        
        .flip-card-inner.is-flipped {
            transform: rotateY(180deg);
        }
        
        .flip-card-front, .flip-card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 2rem;
        }
        
        .flip-card-front {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            color: #1e293b;
            border: 1px solid #e2e8f0;
        }
        
        .flip-card-back {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            transform: rotateY(180deg);
        }

        .category-btn.active {
            background-color: #2563eb;
            color: white;
            border-color: #2563eb;
        }

        /* Chatbot Styles */
        .chat-container {
            position: fixed;
            bottom: 90px;
            right: 20px;
            width: 350px;
            height: 500px;
            background: white;
            border-radius: 1rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            display: none;
            flex-direction: column;
            z-index: 50;
            border: 1px solid #e2e8f0;
            overflow: hidden;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            background-color: #f8fafc;
        }

        .message {
            margin-bottom: 1rem;
            max-width: 80%;
            padding: 0.75rem;
            border-radius: 1rem;
            font-size: 0.875rem;
            line-height: 1.5;
        }

        .message.user {
            background-color: #3b82f6;
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 0.25rem;
        }

        .message.bot {
            background-color: #e2e8f0;
            color: #1e293b;
            margin-right: auto;
            border-bottom-left-radius: 0.25rem;
        }
        
        /* Loading Dot Animation */
        .dot-flashing {
            position: relative;
            width: 6px;
            height: 6px;
            border-radius: 5px;
            background-color: #9ca3af;
            color: #9ca3af;
            animation: dot-flashing 1s infinite linear alternate;
            animation-delay: 0.5s;
        }
        .dot-flashing::before, .dot-flashing::after {
            content: "";
            display: inline-block;
            position: absolute;
            top: 0;
        }
        .dot-flashing::before {
            left: -10px;
            width: 6px;
            height: 6px;
            border-radius: 5px;
            background-color: #9ca3af;
            color: #9ca3af;
            animation: dot-flashing 1s infinite alternate;
            animation-delay: 0s;
        }
        .dot-flashing::after {
            left: 10px;
            width: 6px;
            height: 6px;
            border-radius: 5px;
            background-color: #9ca3af;
            color: #9ca3af;
            animation: dot-flashing 1s infinite alternate;
            animation-delay: 1s;
        }

        @keyframes dot-flashing {
            0% { background-color: #9ca3af; }
            50%, 100% { background-color: #e2e8f0; }
        }

        /* Markdown-like styling for AI response */
        .prose strong { font-weight: 700; color: inherit; }
        .prose ul { list-style-type: disc; padding-left: 1.2em; margin: 0.5em 0; }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4">

    <!-- Header Section -->
    <header class="text-center mb-8 max-w-2xl w-full">
        <div class="inline-block bg-blue-100 text-blue-800 text-xs font-bold px-3 py-1 rounded-full mb-3 flex items-center justify-center gap-1 mx-auto w-fit">
            <span>SVP-PREP + Gemini</span>
            <i class="fas fa-sparkles text-yellow-500"></i>
        </div>
        <h1 class="text-3xl font-bold text-slate-800 mb-2">í•µì‹¬ìš”ì•½ í”Œë˜ì‹œì¹´ë“œ</h1>
        <p class="text-slate-500 text-sm">ì¹´ë“œë¥¼ ë’¤ì§‘ì–´ í•™ìŠµí•˜ê³ , AI ë™ë£Œì™€ ëŒ€í™”í•˜ë©° ë§ˆìŒì„ ì±™ê¸°ì„¸ìš”.</p>
    </header>

    <!-- Category Filter -->
    <div class="flex flex-wrap justify-center gap-2 mb-8 max-w-3xl w-full" id="categoryContainer">
        <!-- Categories will be injected here -->
    </div>

    <!-- Flashcard Section -->
    <div class="w-full max-w-md h-96 perspective-1000 mb-8">
        <div class="flip-card-inner bg-white" id="flashcard">
            
            <!-- Front Side -->
            <div class="flip-card-front" onclick="toggleFlip()">
                <div class="absolute top-4 left-4">
                    <span id="cardCategory" class="text-xs font-bold text-blue-500 bg-blue-50 px-2 py-1 rounded">ê°œë… ì´í•´</span>
                </div>
                <div class="absolute top-4 right-4 text-slate-300">
                    <i class="fas fa-question-circle text-2xl"></i>
                </div>
                <h2 class="text-xl font-bold mb-4 text-center px-4">Q. <span id="cardQuestion">ì§ˆë¬¸ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</span></h2>
                <p class="text-sm text-slate-400 mt-4 animate-bounce">
                    <i class="fas fa-hand-pointer mr-1"></i> íƒ­í•˜ì—¬ ì •ë‹µ í™•ì¸
                </p>
            </div>

            <!-- Back Side -->
            <div class="flip-card-back">
                <div class="absolute top-4 left-4">
                    <span class="text-xs font-bold text-blue-100 bg-blue-600 bg-opacity-30 px-2 py-1 rounded">ì •ë‹µ</span>
                </div>
                <div class="absolute top-4 right-4 text-blue-200 cursor-pointer hover:text-white transition" onclick="resetFlip()" title="ë‹¤ì‹œ ë’¤ì§‘ê¸°">
                    <i class="fas fa-undo text-xl"></i>
                </div>
                
                <div onclick="toggleFlip()" class="flex flex-col items-center justify-center flex-1 w-full">
                    <h3 class="text-lg font-bold mb-3 text-center" id="cardAnswerTitle">í•µì‹¬ í‚¤ì›Œë“œ</h3>
                    <p class="text-sm leading-relaxed mb-4 opacity-90 text-center px-2" id="cardAnswerDesc">
                        ìƒì„¸ ì„¤ëª…ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.
                    </p>
                    <div class="mt-2 text-center">
                        <p class="text-xs text-blue-100" id="cardSource">ì¶œì²˜: ë¬¸í—Œê³ ì°°</p>
                    </div>
                </div>

                <!-- AI Feature Button on Back -->
                <div class="w-full mt-4 pt-3 border-t border-blue-400 border-opacity-40 flex justify-center">
                    <button onclick="askAIForExample(event)" class="flex items-center gap-2 bg-white text-blue-600 px-4 py-2 rounded-full text-xs font-bold shadow-md hover:bg-blue-50 transition transform hover:scale-105">
                        <i class="fas fa-sparkles text-yellow-500"></i> AI ì„ìƒ ì‚¬ë¡€ ë³´ê¸°
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Controls -->
    <div class="flex items-center gap-4 mb-6">
        <button onclick="prevCard()" class="w-12 h-12 rounded-full bg-white text-slate-600 shadow-lg hover:bg-slate-50 active:scale-95 transition flex items-center justify-center">
            <i class="fas fa-chevron-left"></i>
        </button>
        
        <div class="bg-white px-4 py-2 rounded-full shadow-sm text-sm font-medium text-slate-600">
            <span id="currentIndex">1</span> / <span id="totalIndex">10</span>
        </div>

        <button onclick="nextCard()" class="w-12 h-12 rounded-full bg-white text-blue-600 shadow-lg hover:bg-blue-50 active:scale-95 transition flex items-center justify-center">
            <i class="fas fa-chevron-right"></i>
        </button>
    </div>

    <!-- Progress Bar -->
    <div class="w-full max-w-md h-1.5 bg-slate-200 rounded-full overflow-hidden mb-8">
        <div id="progressBar" class="h-full bg-blue-500 transition-all duration-300" style="width: 0%"></div>
    </div>

    <!-- Floating Action Buttons -->
    <div class="fixed bottom-6 right-6 flex flex-col gap-3 z-50">
        <button onclick="openApiKeyModal()" class="w-12 h-12 rounded-full bg-slate-800 text-white shadow-lg hover:bg-slate-700 transition flex items-center justify-center tooltip-trigger" title="AI ì„¤ì •">
            <i class="fas fa-cog"></i>
        </button>
        <button onclick="toggleChat()" class="w-14 h-14 rounded-full bg-blue-600 text-white shadow-lg hover:bg-blue-500 transition flex items-center justify-center animate-pulse-slow">
            <i class="fas fa-comments text-2xl"></i>
        </button>
    </div>

    <!-- Chat Interface -->
    <div id="chatContainer" class="chat-container">
        <div class="bg-blue-600 text-white p-4 flex justify-between items-center">
            <div class="flex items-center gap-2">
                <i class="fas fa-robot"></i>
                <span class="font-bold">AI ë™ë£Œ ìƒë‹´ì‚¬</span>
            </div>
            <button onclick="toggleChat()" class="text-blue-100 hover:text-white"><i class="fas fa-times"></i></button>
        </div>
        <div id="chatMessages" class="chat-messages">
            <div class="message bot">
                ì•ˆë…•í•˜ì„¸ìš”! ì €ëŠ” ì„ ìƒë‹˜ì˜ ì´ì•¼ê¸°ë¥¼ ë“¤ì–´ì¤„ ë™ë£Œ AIì…ë‹ˆë‹¤. <br>
                í™˜ìì•ˆì „ì‚¬ê±´ìœ¼ë¡œ ì¸í•´ ë§ˆìŒì´ í˜ë“œì‹ ê°€ìš”? í¸í•˜ê²Œ ì´ì•¼ê¸°í•´ì£¼ì„¸ìš”. (ë¹„ë°€ì€ ë³´ì¥ë©ë‹ˆë‹¤ ğŸ¤«)
            </div>
        </div>
        <div class="p-3 bg-white border-t border-slate-200">
            <div class="flex gap-2">
                <input type="text" id="chatInput" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." 
                       class="flex-1 border border-slate-300 rounded-full px-4 py-2 text-sm focus:outline-none focus:border-blue-500"
                       onkeypress="handleChatKeyPress(event)">
                <button onclick="sendMessage()" class="bg-blue-600 text-white w-10 h-10 rounded-full flex items-center justify-center hover:bg-blue-700 transition">
                    <i class="fas fa-paper-plane text-sm"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- API Key Modal -->
    <div id="apiKeyModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl p-6 max-w-sm w-full mx-4 shadow-2xl">
            <h3 class="text-lg font-bold mb-2">Gemini API ì„¤ì •</h3>
            <p class="text-sm text-slate-500 mb-4">AI ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë ¤ë©´ API í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤. ì…ë ¥ëœ í‚¤ëŠ” ë¸Œë¼ìš°ì €ì—ë§Œ ì„ì‹œ ì €ì¥ë©ë‹ˆë‹¤.</p>
            <input type="password" id="apiKeyInput" placeholder="Google Gemini API Key ì…ë ¥" 
                   class="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500">
            <div class="flex justify-end gap-2">
                <button onclick="closeApiKeyModal()" class="px-4 py-2 text-slate-600 text-sm hover:bg-slate-100 rounded-lg">ì·¨ì†Œ</button>
                <button onclick="saveApiKey()" class="px-4 py-2 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700">ì €ì¥</button>
            </div>
        </div>
    </div>

    <!-- AI Content Modal -->
    <div id="aiModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl max-w-lg w-full max-h-[80vh] flex flex-col shadow-2xl overflow-hidden">
            <div class="bg-gradient-to-r from-blue-600 to-blue-500 p-4 text-white flex justify-between items-center">
                <h3 class="font-bold flex items-center gap-2"><i class="fas fa-sparkles text-yellow-300"></i> AI ì„ìƒ ì‚¬ë¡€ & í•´ì„¤</h3>
                <button onclick="closeAiModal()" class="hover:text-blue-100"><i class="fas fa-times"></i></button>
            </div>
            <div id="aiModalContent" class="p-6 overflow-y-auto text-slate-700 leading-relaxed text-sm">
                <!-- Content will be injected here -->
                <div class="flex justify-center py-8">
                    <div class="dot-flashing"></div>
                </div>
            </div>
            <div class="p-4 border-t border-slate-100 bg-slate-50 text-right">
                <button onclick="closeAiModal()" class="px-4 py-2 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";

        // Expose AI functions to global scope
        window.saveApiKey = saveApiKey;
        window.sendMessage = sendMessage;
        window.askAIForExample = askAIForExample;

        let genAI = null;
        let model = null;
        let chat = null;

        function getApiKey() {
            return sessionStorage.getItem('gemini_api_key');
        }

        function initGenAI() {
            const key = getApiKey();
            if (key) {
                genAI = new GoogleGenerativeAI(key);
                model = genAI.getGenerativeModel({ model: "gemini-2.5-flash-preview-09-2025" });
                
                // Initialize chat with peer support persona
                chat = model.startChat({
                    history: [
                        {
                            role: "user",
                            parts: [{ text: "ë‹¹ì‹ ì€ í™˜ìì•ˆì „ì‚¬ê±´ì„ ê²½í—˜í•œ ê°„í˜¸ì‚¬ë¥¼ ë•ëŠ” ë”°ëœ»í•˜ê³  ê³µê°ì ì¸ ë™ë£Œì´ì 'ë™ë£Œ ì§€ì§€ì(Peer Supporter)'ì…ë‹ˆë‹¤. ì‚¬ìš©ìê°€ ê²ªì€ ì‹¤ìˆ˜ë‚˜ ê°ì •ì— ëŒ€í•´ ë¹„ë‚œí•˜ì§€ ì•Šê³ , ì ê·¹ì ìœ¼ë¡œ ê²½ì²­í•˜ë©°, SVP-PREP í”„ë¡œê·¸ë¨ì˜ ëŒ€ì²˜ ì „ëµ(ì‹¬í˜¸í¡, ê¸ì •ì  ì¬í•´ì„ ë“±)ì„ ë¶€ë“œëŸ½ê²Œ ê¶Œìœ í•´ì£¼ì„¸ìš”. ì˜ë£Œì  ì¡°ì–¸ì€ í•˜ì§€ ì•Šìœ¼ë©°, ìì‚´ ìœ„í—˜ ì§•í›„ê°€ ë³´ì´ë©´ ì „ë¬¸ê°€ ìƒë‹´ì„ ê¶Œí•˜ì„¸ìš”. í•œêµ­ì–´ë¡œ, ì¡´ëŒ“ë§(í•´ìš”ì²´)ë¡œ ì¹œì ˆí•˜ê²Œ ëŒ€í™”í•˜ì„¸ìš”." }],
                        },
                        {
                            role: "model",
                            parts: [{ text: "ì•ˆë…•í•˜ì„¸ìš”, ì„ ìƒë‹˜. ì €ëŠ” ì„ ìƒë‹˜ì˜ ì´ì•¼ê¸°ë¥¼ ë“¤ì–´ë“œë¦¬ê³  í•¨ê»˜ ê³ ë¯¼ì„ ë‚˜ëˆŒ ë™ë£Œ ì§€ì§€ìì…ë‹ˆë‹¤. ì˜¤ëŠ˜ í•˜ë£¨ëŠ” ì–´ë– ì…¨ë‚˜ìš”? í˜¹ì‹œ ë§ˆìŒ í•œêµ¬ì„ì— ë¬´ê±°ìš´ ì§ì´ ìˆë‹¤ë©´ ì €ì—ê²Œ í„¸ì–´ë†“ìœ¼ì…”ë„ ì¢‹ì•„ìš”. ë¹„ë°€ì€ ê¼­ ì§€í‚¬ê²Œìš”." }],
                        },
                    ],
                });
            }
        }

        function saveApiKey() {
            const input = document.getElementById('apiKeyInput');
            const key = input.value.trim();
            if (key) {
                sessionStorage.setItem('gemini_api_key', key);
                initGenAI();
                closeApiKeyModal();
                alert('API í‚¤ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. AI ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
            } else {
                alert('API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            }
        }

        async function sendMessage() {
            if (!getApiKey()) {
                openApiKeyModal();
                return;
            }

            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (!message) return;

            // UI Update: User Message
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.innerHTML += `<div class="message user">${escapeHtml(message)}</div>`;
            input.value = '';
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            // Show Loading
            const loadingId = 'loading-' + Date.now();
            messagesContainer.innerHTML += `
                <div id="${loadingId}" class="message bot flex items-center gap-2">
                    <div class="dot-flashing mx-2 my-1"></div>
                </div>`;
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            try {
                if (!chat) initGenAI();
                const result = await chat.sendMessage(message);
                const response = result.response.text();

                // Remove loading and show response
                document.getElementById(loadingId).remove();
                messagesContainer.innerHTML += `<div class="message bot prose">${formatAIResponse(response)}</div>`;
            } catch (error) {
                document.getElementById(loadingId).remove();
                messagesContainer.innerHTML += `<div class="message bot text-red-500">ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. API í‚¤ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.</div>`;
                console.error(error);
            }
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        async function askAIForExample(event) {
            event.stopPropagation(); // Prevent card flip
            
            if (!getApiKey()) {
                openApiKeyModal();
                return;
            }

            // Get current card data
            const currentCard = allCards[window.currentIndex]; // Access global variable
            const prompt = `
                ê°„í˜¸ì‚¬ë¥¼ ìœ„í•œ ì œ2ì˜ í”¼í•´ì ì˜ˆë°© í”„ë¡œê·¸ë¨ í•™ìŠµ ì¤‘ì…ë‹ˆë‹¤.
                ë‹¤ìŒ ê°œë…ì— ëŒ€í•´ ì„ìƒ í˜„ì¥ì—ì„œ ë°œìƒí•  ìˆ˜ ìˆëŠ” êµ¬ì²´ì ì¸ ê°€ìƒ ì‚¬ë¡€(ì‹œë‚˜ë¦¬ì˜¤)ì™€ ê°„í˜¸ì‚¬ê°€ ì–´ë–»ê²Œ ëŒ€ì²˜í•´ì•¼ í•˜ëŠ”ì§€ ë”°ëœ»í•œ ì¡°ì–¸ì„ í¬í•¨í•´ì„œ ì„¤ëª…í•´ì£¼ì„¸ìš”.
                
                ê°œë…: ${currentCard.answerTitle}
                ì„¤ëª…: ${currentCard.answerDesc}
                
                ì¶œë ¥ í˜•ì‹:
                1. ğŸ¥ ì„ìƒ ì‚¬ë¡€ ì‹œë‚˜ë¦¬ì˜¤ (êµ¬ì²´ì ìœ¼ë¡œ)
                2. ğŸ’¡ ì ìš© í¬ì¸íŠ¸ ë° ì¡°ì–¸
            `;

            document.getElementById('aiModal').classList.remove('hidden');
            document.getElementById('aiModalContent').innerHTML = `
                <div class="flex flex-col items-center justify-center py-12 gap-4">
                    <div class="dot-flashing bg-blue-400"></div>
                    <p class="text-slate-500 text-xs">AIê°€ ì—´ì‹¬íˆ ì‚¬ë¡€ë¥¼ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
                </div>`;

            try {
                if (!model) initGenAI();
                const result = await model.generateContent(prompt);
                const response = result.response.text();
                
                document.getElementById('aiModalContent').innerHTML = `<div class="prose space-y-4">${formatAIResponse(response)}</div>`;
            } catch (error) {
                document.getElementById('aiModalContent').innerHTML = `<p class="text-red-500 text-center">ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.<br>API í‚¤ë¥¼ í™•ì¸í•˜ê±°ë‚˜ ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</p>`;
            }
        }

        // Helper to format text with simple markdown
        function formatAIResponse(text) {
            return text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\n/g, '<br>');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Initialize on load if key exists
        if(getApiKey()) initGenAI();

    </script>

    <script>
        // --- Existing Flashcard Logic (Updated) ---

        const allCards = [
            {
                id: 1,
                category: "ê°œë… ì •ì˜",
                question: "'ì œ2ì˜ í”¼í•´ì(Second Victim)'ë€ ëˆ„êµ¬ë¥¼ ì˜ë¯¸í•˜ë‚˜ìš”?",
                answerTitle: "í™˜ìì•ˆì „ì‚¬ê±´ì— ì—°ë£¨ëœ ì˜ë£Œì§„",
                answerDesc: "ì˜ˆìƒì¹˜ ëª»í•œ í™˜ìì•ˆì „ì‚¬ê±´ì— ì§ê°„ì ‘ì ìœ¼ë¡œ ì—°ë£¨ë˜ì–´ ì£„ì±…ê°, ë¶ˆì•ˆ, ìˆ˜ë©´ ì¥ì•  ë“± ì‹¬ë¦¬ì Â·ì •ì„œì  ì–´ë ¤ì›€ì„ ê²ªëŠ” ê°„í˜¸ì‚¬, ì˜ì‚¬ ë“± ëª¨ë“  ë³´ê±´ì˜ë£Œì¸ì„ ë§í•©ë‹ˆë‹¤.",
                source: "ì¶œì²˜: Albert Wu (2000), Scott et al. (2009)"
            },
            {
                id: 2,
                category: "ê°œë… ì •ì˜",
                question: "í™˜ìì•ˆì „ì‚¬ê±´ì˜ 'ì œ3ì˜ í”¼í•´ì'ëŠ” ëˆ„êµ¬ì¸ê°€ìš”?",
                answerTitle: "ì˜ë£Œê¸°ê´€ (Healthcare Organization)",
                answerDesc: "ì‚¬ê±´ ë°œìƒìœ¼ë¡œ ì¸í•´ ëª…ì˜ˆ ì‹¤ì¶”, í™˜ì ì‹ ë¢° í•˜ë½, ì†Œì†¡ ë¹„ìš© ë°œìƒ ë“± ì¡°ì§ ì°¨ì›ì˜ ì†í•´ë¥¼ ì…ëŠ” ë³‘ì›ì´ë‚˜ ê¸°ê´€ì„ ì˜ë¯¸í•©ë‹ˆë‹¤.",
                source: "ì¶œì²˜: Denham (2007)"
            },
            {
                id: 3,
                category: "íšŒë³µ ê³¼ì •",
                question: "Scottì˜ íšŒë³µ 6ë‹¨ê³„ ì¤‘, ì‚¬ê±´ ì§í›„ 'ì–´ë–»ê²Œ ì´ëŸ° ì¼ì´?'ë¼ë©° í˜¼ë€ì„ ê²ªëŠ” ì²« ë‹¨ê³„ëŠ”?",
                answerTitle: "1ë‹¨ê³„: í˜¼ëˆê³¼ ì‚¬ê³  ë°˜ì‘",
                answerDesc: "(Chaos and Accident Response) ì‚¬ê±´ì„ ì²˜ìŒ ì¸ì‹í•˜ê³  ì¶©ê²©, ê³µí¬, ë‹¹í™©ìŠ¤ëŸ¬ì›€, ë¬´ë ¥ê°ì„ ê²½í—˜í•˜ë©° ë‚´ì  í˜¼ë€ì„ ê²ªëŠ” ì‹œê¸°ì…ë‹ˆë‹¤.",
                source: "ì¶œì²˜: Scott et al. (2009)"
            },
            {
                id: 4,
                category: "íšŒë³µ ê³¼ì •",
                question: "íšŒë³µ ê³¼ì •ì˜ ê²°ê³¼ ì¤‘ í•˜ë‚˜ë¡œ, ì‚¬ê±´ì„ í†µí•´ í†µì°°ë ¥ì„ ì–»ê³  ê¸ì •ì ìœ¼ë¡œ ë³€í™”í•˜ëŠ” ìƒíƒœëŠ”?",
                answerTitle: "ì„±ì¥ (Thriving)",
                answerDesc: "ë‹¨ìˆœí•œ ìƒì¡´(Surviving)ì´ë‚˜ í¬ê¸°(Dropping out)ê°€ ì•„ë‹Œ, ìê¸° ìˆ˜ìš©ê³¼ ì—°ë¯¼ì„ í†µí•´ ì‚¬ê±´ ì´ì „ë³´ë‹¤ ë” ì„±ìˆ™í•´ì§€ê³  í™˜ìì•ˆì „ ê°œì„ ì— ê¸°ì—¬í•˜ëŠ” ìƒíƒœì…ë‹ˆë‹¤.",
                source: "ì¶œì²˜: Scott et al. (2009)"
            },
            {
                id: 5,
                category: "ì§€ì› ì „ëµ",
                question: "ì œ2ì˜ í”¼í•´ìê°€ ê°€ì¥ ì„ í˜¸í•˜ëŠ” ì§€ì› ë°©ì‹ì´ì, ì •ì„œì  ì‘ê¸‰ì²˜ì¹˜ì˜ í•µì‹¬ì€?",
                answerTitle: "ë™ë£Œ ì§€ì§€ (Peer Support)",
                answerDesc: "ë¹„ë‚œ ì—†ì´ ê²½ì²­í•˜ê³  ê³µê°í•´ ì£¼ëŠ” ë™ë£Œì˜ ì¡´ì¬ê°€ íšŒë³µì˜ í•µì‹¬ì…ë‹ˆë‹¤. ì—°êµ¬ ê²°ê³¼, ë§ì€ ì˜ë£Œì§„ì´ ì „ë¬¸ ìƒë‹´ë³´ë‹¤ ë™ë£Œì™€ì˜ ëŒ€í™”ë¥¼ ì„ í˜¸í–ˆìŠµë‹ˆë‹¤.",
                source: "ì¶œì²˜: Choi et al. (2022)"
            },
            {
                id: 6,
                category: "ì§€ì› ì „ëµ",
                question: "Scottì˜ 3ë‹¨ê³„ ì¤‘ì¬ ëª¨ë¸(Three-Tiered Model)ì—ì„œ '2ë‹¨ê³„' ì§€ì›ì€ ë¬´ì—‡ì¸ê°€ìš”?",
                answerTitle: "í›ˆë ¨ëœ ë™ë£Œì˜ ì§€ì› (Trained Peer Support)",
                answerDesc: "1ë‹¨ê³„(ë¶€ì„œ/ë™ë£Œì˜ ì¼ë°˜ì  ì§€ì§€)ë¥¼ ë„˜ì–´, ì „ë¬¸ êµìœ¡ì„ ë°›ì€ ë™ë£Œ(Peer Supporter)ê°€ 1:1ë¡œ ì œê³µí•˜ëŠ” êµ¬ì¡°í™”ëœ ì •ì„œì  ì§€ì§€ ë° ë””ë¸Œë¦¬í•‘ì…ë‹ˆë‹¤.",
                source: "ì¶œì²˜: Scott et al. (2010)"
            },
            {
                id: 7,
                category: "ì¡°ì§ ë¬¸í™”",
                question: "ì‹¤ìˆ˜ë¥¼ ê°œì¸ì˜ ë¹„ë‚œë³´ë‹¤ 'í•™ìŠµì˜ ê¸°íšŒ'ë¡œ ë³´ê³  ì‹œìŠ¤í…œì ìœ¼ë¡œ ì ‘ê·¼í•˜ëŠ” ë¬¸í™”ëŠ”?",
                answerTitle: "ê³µì • ë¬¸í™” (Just Culture)",
                answerDesc: "ì¸ì  ì˜¤ë¥˜ëŠ” ì‹œìŠ¤í…œì˜ ë¬¸ì œë¡œ ë³´ë˜, ê³ ì˜ì  ìœ„ë°˜ê³¼ ì‹¤ìˆ˜ë¥¼ êµ¬ë¶„í•˜ì—¬ ê³µì •í•˜ê²Œ ì±…ì„ì„ ë¬»ê³  ì•ˆì „ì„ í•™ìŠµí•˜ëŠ” í™˜ê²½ì…ë‹ˆë‹¤.",
                source: "ì¶œì²˜: Marx (2001), AHRQ"
            },
            {
                id: 8,
                category: "ì´ë¡ ì  ë°°ê²½",
                question: "ìŠ¤ìœ„ìŠ¤ ì¹˜ì¦ˆ ëª¨ë¸ì—ì„œ 'ì ì¬ì  ì¡°ê±´(Latent conditions)'ì´ë€?",
                answerTitle: "ì‹œìŠ¤í…œ ë° ì„¤ê³„ìƒì˜ ê²°í•¨",
                answerDesc: "ì¡°ì§ì˜ êµ¬ì¡°, ì •ì±…, ì¸ë ¥ ë¶€ì¡± ë“± í‰ì†Œì—” ë“œëŸ¬ë‚˜ì§€ ì•Šë‹¤ê°€, ì˜ë£Œì§„ì˜ ì‹¤ìˆ˜(ëŠ¥ë™ì  ì‹¤íŒ¨)ì™€ ê²°í•©ë  ë•Œ ì‚¬ê³ ë¥¼ ìœ ë°œí•˜ëŠ” êµ¬ë©ë“¤ì„ ë§í•©ë‹ˆë‹¤.",
                source: "ì¶œì²˜: James Reason (2000)"
            },
            {
                id: 9,
                category: "ì†Œí†µ ë°©ì•ˆ",
                question: "í™˜ì/ë³´í˜¸ìì—ê²Œ ì‚¬ê±´ ë°œìƒ ì‚¬ì‹¤ì„ ì •ì§í•˜ê²Œ ì•Œë¦¬ê³  ì‚¬ê³¼í•˜ëŠ” ì ˆì°¨ëŠ”?",
                answerTitle: "í™˜ìì•ˆì „ì‚¬ê±´ ì†Œí†µí•˜ê¸° (Disclosure)",
                answerDesc: "ì˜êµ­ì˜ 'ì„±ì‹¤ì˜ ì˜ë¬´(Duty of Candour)'ì²˜ëŸ¼, íˆ¬ëª…í•œ ì •ë³´ ì œê³µê³¼ ì§„ì‹¬ ì–´ë¦° ì‚¬ê³¼ëŠ” ì†Œì†¡ì„ ì¤„ì´ê³  ì‹ ë¢°ë¥¼ íšŒë³µí•˜ëŠ” í•µì‹¬ì…ë‹ˆë‹¤.",
                source: "ì¶œì²˜: AHRQ CANDOR Toolkit"
            },
            {
                id: 10,
                category: "ëŒ€ì²˜ ì „ëµ",
                question: "ì‚¬ê±´ í›„ 'íšŒí”¼ ì¤‘ì‹¬ ëŒ€ì²˜(Avoidance-Oriented Coping)'ì˜ ì¥ê¸°ì  ìœ„í—˜ì„±ì€?",
                answerTitle: "íšŒë³µ ì§€ì—° ë° ë²ˆì•„ì›ƒ ìœ„í—˜ ì¦ê°€",
                answerDesc: "ìˆ /ì•½ë¬¼ì— ì˜ì¡´í•˜ê±°ë‚˜ í™˜ìë¥¼ í”¼í•˜ëŠ” í–‰ë™ì€ ë‹¨ê¸°ì  ë¶ˆì•ˆì€ ë‚®ì¶œ ìˆ˜ ìˆìœ¼ë‚˜, ì¥ê¸°ì ìœ¼ë¡œëŠ” ì§ì—… ë§Œì¡±ë„ë¥¼ ë–¨ì–´ëœ¨ë¦¬ê³  ì´ì§ ì˜ë„ë¥¼ ë†’ì…ë‹ˆë‹¤.",
                source: "ì¶œì²˜: Busch et al. (2020)"
            }
        ];

        // State Management
        let currentCards = [...allCards];
        let currentIndex = 0;
        let isFlipped = false;
        let activeCategory = 'ì „ì²´';
        window.currentIndex = 0; // Expose for AI

        // DOM Elements
        const flashcardEl = document.getElementById('flashcard');
        const questionEl = document.getElementById('cardQuestion');
        const categoryEl = document.getElementById('cardCategory');
        const answerTitleEl = document.getElementById('cardAnswerTitle');
        const answerDescEl = document.getElementById('cardAnswerDesc');
        const sourceEl = document.getElementById('cardSource');
        const currentIndexEl = document.getElementById('currentIndex');
        const totalIndexEl = document.getElementById('totalIndex');
        const progressBarEl = document.getElementById('progressBar');
        const categoryContainer = document.getElementById('categoryContainer');
        const chatContainer = document.getElementById('chatContainer');

        // Initialize Categories
        function initCategories() {
            const categories = ['ì „ì²´', ...new Set(allCards.map(card => card.category))];
            
            categories.forEach(cat => {
                const btn = document.createElement('button');
                btn.className = `category-btn px-4 py-2 rounded-full border border-slate-200 text-sm font-medium transition hover:bg-slate-100 ${cat === 'ì „ì²´' ? 'active' : 'bg-white text-slate-600'}`;
                btn.innerText = cat;
                btn.onclick = () => filterCategory(cat, btn);
                categoryContainer.appendChild(btn);
            });
        }

        function filterCategory(category, btnElement) {
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('active', 'bg-blue-600', 'text-white', 'border-blue-600');
                btn.classList.add('bg-white', 'text-slate-600');
            });
            btnElement.classList.add('active');
            btnElement.classList.remove('bg-white', 'text-slate-600');

            activeCategory = category;
            if (category === 'ì „ì²´') {
                currentCards = [...allCards];
            } else {
                currentCards = allCards.filter(card => card.category === category);
            }
            
            currentIndex = 0;
            window.currentIndex = 0; // AI sync
            resetFlip();
            updateCardDisplay();
        }

        function updateCardDisplay() {
            if (currentCards.length === 0) return;

            const card = currentCards[currentIndex];
            
            questionEl.innerText = card.question;
            categoryEl.innerText = card.category;

            answerTitleEl.innerText = card.answerTitle;
            answerDescEl.innerText = card.answerDesc;
            sourceEl.innerText = card.source;

            currentIndexEl.innerText = currentIndex + 1;
            totalIndexEl.innerText = currentCards.length;

            const progress = ((currentIndex + 1) / currentCards.length) * 100;
            progressBarEl.style.width = `${progress}%`;
            
            // Sync Global index for AI
            window.currentIndex = allCards.findIndex(c => c.id === card.id);
        }

        window.toggleFlip = function() {
            isFlipped = !isFlipped;
            if (isFlipped) {
                flashcardEl.classList.add('is-flipped');
            } else {
                flashcardEl.classList.remove('is-flipped');
            }
        }

        window.resetFlip = function() {
            isFlipped = false;
            flashcardEl.classList.remove('is-flipped');
        }

        window.nextCard = function() {
            if (currentIndex < currentCards.length - 1) {
                resetFlip();
                setTimeout(() => {
                    currentIndex++;
                    updateCardDisplay();
                }, 200);
            } else {
                resetFlip();
                setTimeout(() => {
                    currentIndex = 0;
                    updateCardDisplay();
                }, 200);
            }
        }

        window.prevCard = function() {
            if (currentIndex > 0) {
                resetFlip();
                setTimeout(() => {
                    currentIndex--;
                    updateCardDisplay();
                }, 200);
            }
        }

        // --- Chat & Modal Logic ---
        window.openApiKeyModal = function() {
            document.getElementById('apiKeyModal').classList.remove('hidden');
            document.getElementById('apiKeyModal').classList.add('flex');
        }

        window.closeApiKeyModal = function() {
            document.getElementById('apiKeyModal').classList.add('hidden');
            document.getElementById('apiKeyModal').classList.remove('flex');
        }

        window.toggleChat = function() {
            if (chatContainer.style.display === 'flex') {
                chatContainer.style.display = 'none';
            } else {
                chatContainer.style.display = 'flex';
                // Focus input
                setTimeout(() => document.getElementById('chatInput').focus(), 100);
            }
        }

        window.handleChatKeyPress = function(e) {
            if (e.key === 'Enter') sendMessage();
        }

        window.closeAiModal = function() {
            document.getElementById('aiModal').classList.add('hidden');
        }

        // Keyboard Navigation
        document.addEventListener('keydown', (e) => {
            if (document.getElementById('apiKeyModal').classList.contains('flex')) return;
            if (document.getElementById('chatContainer').style.display === 'flex') return;
            
            if (e.code === 'Space' || e.code === 'Enter') {
                toggleFlip();
            } else if (e.code === 'ArrowRight') {
                nextCard();
            } else if (e.code === 'ArrowLeft') {
                prevCard();
            }
        });

        // Init
        initCategories();
        updateCardDisplay();

    </script>
</body>
</html>