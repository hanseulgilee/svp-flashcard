<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SVP-PREP: 제2의 피해자 예방 프로그램</title>
    
    <!-- React & ReactDOM (엔진) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel (번역기) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS (디자인) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 애니메이션 스타일 -->
    <style>
        .perspective-1000 { perspective: 1000px; }
        .transform-style-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }
        .animate-fade-in { animation: fadeIn 0.4s ease-out; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(255,255,255,0.1); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.3); border-radius: 4px; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-slate-50 text-gray-900">
    <div id="root"></div>

    <script type="text/babel">
        // 아이콘 컴포넌트들 (Lucide Icons SVG 직접 구현 - 설치 없이 실행하기 위함)
        const Shield = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
        );
        const Star = ({ size = 24, fill = "none" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill={fill} stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
        );
        const BookOpen = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
        );
        const ChevronRight = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="9 18 15 12 9 6"/></svg>
        );
        const ChevronLeft = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="15 18 9 12 15 6"/></svg>
        );
        const Home = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
        );
        const HelpCircle = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
        );
        const RefreshCw = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 2v6h-6"/><path d="M3 12a9 9 0 0 1 15-6.7L21 8"/><path d="M3 22v-6h6"/><path d="M21 12a9 9 0 0 1-15 6.7L3 16"/></svg>
        );
        const Shuffle = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="16 3 21 3 21 8"/><line x1="4" y1="20" x2="21" y2="3"/><polyline points="21 16 21 21 16 21"/><line x1="15" y1="15" x2="21" y2="21"/><line x1="4" y1="4" x2="9" y2="9"/></svg>
        );
        const Eye = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
        );
        const CheckCircle = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
        );
        const Award = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="8" r="7"/><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"/></svg>
        );
        const RotateCcw = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>
        );
        const MessageCircle = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></svg>
        );
        const HeartHandshake = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
              <path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z" />
              <path d="M12 5 9.04 7.96a2.17 2.17 0 0 0 0 3.08v0c.82.82 2.13.85 3 .07l2.07-1.9a2.82 2.82 0 0 1 3.18 0l2.07 1.9c.87.78 2.18.75 3-.07v0a2.17 2.17 0 0 0 0-3.08Z" />
            </svg>
        );
        const Stethoscope = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
              <path d="M4.8 2.3A.3.3 0 1 0 5 2H4a2 2 0 0 0-2 2v5a6 6 0 0 0 6 6v0a6 6 0 0 0 6-6V4a2 2 0 0 0-2-2h-1a.2.2 0 1 0 .3.3" />
              <path d="M8 15v1a6 6 0 0 0 6 6v0a6 6 0 0 0 6-6v-4" />
              <circle cx="20" cy="10" r="2" />
            </svg>
        );

        // --- 데이터 (34문항 전체 유지) ---
        const originalFlashcards = [
          // Module 1: 제2의 피해자 현상의 이해
          { id: 1, category: "정의", difficulty: "easy", module: "understanding", question: "'제2의 피해자(Second Victim)'란 누구를 의미하나요?", answer: "환자안전사건 발생 후 심리적·정서적 어려움(죄책감, 불안 등)을 겪는 의료진을 의미합니다.", hint: "1990년대 Albert Wu 박사가 처음 사용한 용어입니다." },
          { id: 2, category: "피해 유형", difficulty: "easy", module: "understanding", question: "환자안전사건의 피해자 유형 중 '제3의 피해자(Third Victim)'는 누구인가요?", answer: "사건 발생 시 평판 손상이나 신뢰도 하락 등의 피해를 입을 수 있는 '의료기관'을 의미합니다.", hint: "환자(1차), 의료진(2차) 외의 주체입니다." },
          { id: 19, category: "증상", difficulty: "easy", module: "understanding", question: "제2의 피해자가 경험할 수 있는 '신체적 증상'에는 어떤 것들이 있나요?", answer: "수면 장애, 피로, 두통, 근육 긴장, 빠른 심박수, 메스꺼움 등이 있습니다.", hint: "스트레스로 인한 몸의 반응입니다." },
          { id: 20, category: "증상", difficulty: "easy", module: "understanding", question: "제2의 피해자가 겪는 '심리적 반응' 중 가장 흔한 감정들은 무엇인가요?", answer: "죄책감, 불안, 수치심, 공포, 분노, 무력감, 우울 등이 있습니다.", hint: "사건 직후 가장 많이 느끼는 감정입니다." },
          { id: 15, category: "현상의 이해", difficulty: "easy", module: "understanding", question: "제2의 피해자에게 '불필요한 것'으로, 회복을 방해하고 사건을 숨기게 만드는 요인은?", answer: "비난과 처벌 (Blaming and Punishment)", hint: "낙인, 고립, 강요된 침묵도 이에 포함됩니다." },
          { id: 5, category: "대처 전략", difficulty: "easy", module: "understanding", question: "대처 전략 중, '다시는 같은 실수를 하지 않겠다'며 규정을 엄격히 준수하고 확인을 강화하는 유형은?", answer: "업무 중심 대처 (Task-Oriented Coping)", hint: "가장 흔한 유형이며, 환자 안전은 강화되지만 강박적이 될 수 있습니다." },
          { id: 3, category: "회복 과정", difficulty: "hard", module: "understanding", question: "제2의 피해자 회복 6단계 중, 사건을 계속 재평가하며 '내가 놓친 게 뭐지?'라고 자책하는 2단계는 무엇인가요?", answer: "침범적 성찰 (Intrusive Reflections)", hint: "죄책감, 고립감, 자기 의심이 특징인 단계입니다." },
          { id: 21, category: "회복 과정", difficulty: "hard", module: "understanding", question: "회복 6단계 중 3단계인 '온전함의 회복(Restoring Integrity)' 단계의 특징은?", answer: "신뢰하는 동료나 가족에게 지지를 구하며, 자신의 직업적 정체성을 회복하려고 노력하는 단계입니다.", hint: "혼자 끙끙 앓다가 처음으로 도움을 구하는 시기입니다." },
          { id: 22, category: "회복 과정", difficulty: "hard", module: "understanding", question: "회복 6단계 중 4단계인 '심문 견디기(Enduring the Inquisition)'는 무엇을 의미하나요?", answer: "사건에 대한 내부 조사나 보고 과정에서 느끼는 압박감과 '내가 감시당하고 있다'는 느낌을 갖는 단계입니다.", hint: "조직의 반응에 민감해지는 시기입니다." },
          { id: 4, category: "회복 과정", difficulty: "hard", module: "understanding", question: "회복의 마지막 단계인 '나아가기(Moving On)'의 3가지 결과(경로)는 무엇인가요?", answer: "포기(Dropping Out), 생존(Surviving), 성장(Thriving)", hint: "일을 그만두거나, 고통을 안고 버티거나, 긍정적으로 승화하는 것입니다." },
          { id: 16, category: "회복 과정", difficulty: "hard", module: "understanding", question: "회복 5단계인 '정서적 응급처치' 단계에서 주로 하게 되는 생각은?", answer: "\"나한테 무슨 문제가 있는 건가?\", \"어디에 도움을 요청할 수 있을까?\"", hint: "전문적인 지원을 모색하기 시작하는 단계입니다." },
          { id: 18, category: "정의", difficulty: "hard", module: "understanding", question: "2022년 ERNST 그룹이 정의한 제2의 피해자 핵심 3요소는?", answer: "모든 의료 종사자(Involved Persons), 행동의 내용(Content of Action), 부정적 영향(Impact)", hint: "기존 정의를 확장하여 더 구체화했습니다." },

          // Module 2: 제2의 피해자 지원
          { id: 6, category: "지원", difficulty: "easy", module: "support", question: "제2의 피해자가 사건 직후 가장 선호하며 효과적인 지원 방식은 무엇인가요?", answer: "동료의 지지 (Peer Support)", hint: "정서적 응급처치의 핵심입니다." },
          { id: 23, category: "지원", difficulty: "easy", module: "support", question: "동료 지원가가 하지 말아야 할 행동(Don'ts)은 무엇인가요?", answer: "사건의 원인을 판단하거나, 해결책을 강요하거나, 섣부른 법적 조언을 하는 것입니다.", hint: "경청과 공감이 우선이며, 판단은 금물입니다." },
          { id: 10, category: "동료 지원", difficulty: "easy", module: "support", question: "동료 지원자의 역할 중, 비판 없이 감정을 들어주고 '당신 잘못이 아니다'라는 메시지를 전달하는 역할은?", answer: "경청자 (Listener)", hint: "공감자, 연결자, 회복 촉진자와 함께 동료 지원의 핵심 역할입니다." },
          { id: 24, category: "지원 모델", difficulty: "hard", module: "support", question: "Scott(2010)의 3단계 지원 모델 중, 모든 직원이 부서 내에서 제공받는 가장 기초적인 'Tier 1' 지원은?", answer: "부서 차원의 즉각적인 정서적 지지와 위로 (Unit Level Support)", hint: "동료나 관리자가 현장에서 바로 제공하는 도움입니다." },
          { id: 25, category: "지원 모델", difficulty: "hard", module: "support", question: "Scott의 지원 모델 중 'Tier 2'는 누구에 의해 제공되나요?", answer: "훈련받은 동료 지원가 (Trained Peer Supporters)", hint: "전문적인 교육을 받고 환자안전사건에 대한 이해가 깊은 동료입니다." },
          { id: 26, category: "지원 모델", difficulty: "hard", module: "support", question: "Scott의 지원 모델 중 'Tier 3'는 어떤 경우에 필요한가요?", answer: "전문적인 심리 상담이나 치료가 필요한 경우 (Professional Help)", hint: "동료 지원만으로 해결되지 않는 심각한 트라우마가 있을 때입니다." },
          { id: 9, category: "회복 탄력성", difficulty: "hard", module: "support", question: "어려운 상황에서도 이해 가능성, 관리 가능성, 의미성을 느낄 때 스트레스를 잘 이겨내는 능력(Antonovsky의 개념)은?", answer: "응집감 (Sense of Coherence, SOC)", hint: "회복탄력성(Resilience)의 주요 요소 중 하나입니다." },
          { id: 14, category: "지원 프로그램", difficulty: "hard", module: "support", question: "미국 존스홉킨스 병원에서 운영하는 대표적인 동료 지원 프로그램의 이름은?", answer: "RISE (Resilience in Stressful Events)", hint: "24시간 내 동료 지원을 제공하는 것으로 유명합니다." },
          { id: 27, category: "지원 프로그램", difficulty: "hard", module: "support", question: "미주리 대학 병원에서 개발한 'forYOU' 팀의 주된 목적은 무엇인가요?", answer: "의료진의 안녕을 돕고 제2의 피해자를 지원하기 위한 신속 대응 팀", hint: "Scott 박사가 주도하여 만든 대표적인 모델입니다." },

          // Module 3: 환자안전 문화와 소통
          { id: 8, category: "소통", difficulty: "easy", module: "culture", question: "환자안전사건 발생 시 환자/보호자에게 사실을 정직하게 알리고 공감하며 사과하는 절차를 무엇이라 하나요?", answer: "환자안전사건 소통하기 (Disclosure of Patient Safety Incidents)", hint: "영국에서는 Duty of Candour라고도 합니다." },
          { id: 28, category: "소통", difficulty: "easy", module: "culture", question: "환자안전사건 소통(Disclosure)이 제2의 피해자에게 주는 긍정적인 효과는?", answer: "죄책감을 덜고, 정직하게 사과함으로써 전문직으로서의 윤리적 책임을 다했다는 안도감을 줍니다.", hint: "숨기는 것보다 정직한 것이 회복에 도움이 됩니다." },
          { id: 11, category: "문화", difficulty: "easy", module: "culture", question: "위험 상황에서 의료진이 우려를 표현하고 목소리를 내는 행동을 무엇이라 하나요?", answer: "스피크 업 (Speaking Up)", hint: "침묵은 동의가 아닌 방관이 될 수 있습니다." },
          { id: 29, category: "보고", difficulty: "easy", module: "culture", question: "환자안전사건 보고의 가장 주된 목적은 무엇인가요?", answer: "처벌이 아닌, 시스템의 결함을 찾아 개선하여 재발을 방지하는 것 (학습)", hint: "누가 잘못했는지 찾는 것이 아닙니다." },
          { id: 7, category: "문화", difficulty: "hard", module: "culture", question: "실수를 개인의 무능이 아닌 시스템의 문제로 보고, 비난 대신 학습을 강조하는 조직 문화는?", answer: "공정 문화 (Just Culture)", hint: "안전 문화의 핵심 요소입니다." },
          { id: 30, category: "문화", difficulty: "hard", module: "culture", question: "'공정 문화(Just Culture)'에서 처벌의 대상이 되는 행동은 무엇인가요?", answer: "고의적인 위반이나 음주 진료와 같은 무모한 행동 (Reckless Behavior)", hint: "단순한 인간의 실수(Human Error)와는 구분됩니다." },
          { id: 12, category: "원인 분석", difficulty: "hard", module: "culture", question: "환자안전사건의 근본적인 원인을 찾기 위해 '왜?'를 반복하며 시스템적 요인을 분석하는 방법은?", answer: "근본원인분석 (RCA, Root Cause Analysis)", hint: "개인의 실수가 아닌 시스템의 문제에 집중합니다." },
          { id: 31, category: "원인 분석", difficulty: "hard", module: "culture", question: "근본원인분석(RCA)을 수행하기에 가장 적절한 시기는 언제인가요?", answer: "사건 발생 후 가능한 빠른 시일 내 (보통 45일 이내)", hint: "시간이 지나면 기억이 소실될 수 있습니다." },
          { id: 13, category: "이론", difficulty: "hard", module: "culture", question: "환자안전사건은 여러 방어층의 구멍이 일렬로 정렬될 때 발생한다는 Reason의 모델은?", answer: "스위스 치즈 모델 (Swiss Cheese Model)", hint: "능동적 실패와 잠재적 조건이 결합될 때 사고가 발생합니다." },
          { id: 32, category: "이론", difficulty: "hard", module: "culture", question: "스위스 치즈 모델에서 '잠재적 조건(Latent Conditions)'이란 무엇인가요?", answer: "조직, 관리, 시스템상의 결함 (예: 인력 부족, 장비 노후, 불명확한 절차)", hint: "사고 발생 오래 전부터 존재하던 위험 요소입니다." },
          { id: 17, category: "소통", difficulty: "hard", module: "culture", question: "환자안전사건 소통하기(Disclosure)의 4가지 핵심 원칙 중, 전문 용어를 피하고 쉽게 설명하는 것은?", answer: "명확성 (Clarity)", hint: "정직성, 공감, 책임과 함께 중요한 원칙입니다." },
          { id: 33, category: "소통", difficulty: "hard", module: "culture", question: "효과적인 의사소통을 위한 'ASSIST' 모델의 첫 단계 'A'는 무엇을 의미하나요?", answer: "Acknowledge (사건 발생을 인정하고 환자의 감정을 알아차림)", hint: "소통의 시작입니다." }
        ];

        const MODULES = {
          understanding: { title: "제2의 피해자 현상의 이해", icon: <Stethoscope size={20} />, desc: "정의, 증상, 회복 과정" },
          support: { title: "제2의 피해자 지원", icon: <HeartHandshake size={20} />, desc: "동료 지원, 지원 프로그램" },
          culture: { title: "환자안전 문화와 소통", icon: <MessageCircle size={20} />, desc: "공정 문화, 소통(Disclosure)" }
        };

        const { useState, useEffect } = React;

        const IntroScreen = ({ onStart }) => {
          const [tab, setTab] = useState('level'); // 'level' | 'topic'

          return (
            <div className="flex flex-col items-center justify-center min-h-[75vh] px-4 animate-fade-in w-full max-w-lg mx-auto">
              <div className="bg-white p-6 md:p-8 rounded-3xl shadow-xl border border-emerald-100 w-full text-center transform transition-all hover:shadow-2xl">
                <div className="bg-emerald-50 w-24 h-24 rounded-full flex items-center justify-center mx-auto mb-6 shadow-sm">
                  <HeartHandshake className="w-12 h-12 text-emerald-600" />
                </div>
                <h2 className="text-2xl md:text-3xl font-bold text-gray-800 mb-2 tracking-tight">SVP-PREP</h2>
                <p className="text-gray-500 mb-8 text-sm md:text-base leading-relaxed">
                  의료진의 마음을 돌보는<br/>환자안전사건 예방 학습 프로그램
                </p>

                {/* 탭 메뉴 */}
                <div className="flex p-1.5 bg-gray-50 rounded-2xl mb-8 border border-gray-100 relative">
                  <button 
                    onClick={() => setTab('level')}
                    className={`flex-1 py-2.5 text-sm font-bold rounded-xl transition-all duration-300 ${tab === 'level' ? 'bg-white text-emerald-700 shadow-md ring-1 ring-black/5' : 'text-gray-400 hover:text-gray-600'}`}
                  >
                    난이도별
                  </button>
                  <button 
                    onClick={() => setTab('topic')}
                    className={`flex-1 py-2.5 text-sm font-bold rounded-xl transition-all duration-300 ${tab === 'topic' ? 'bg-white text-emerald-700 shadow-md ring-1 ring-black/5' : 'text-gray-400 hover:text-gray-600'}`}
                  >
                    주제별
                  </button>
                </div>
                
                <div className="space-y-4 min-h-[200px]">
                  {tab === 'level' ? (
                    // 난이도별 선택 버튼
                    <>
                      <button 
                        onClick={() => onStart('difficulty', 'easy')}
                        className="w-full bg-emerald-50/50 hover:bg-emerald-50 border border-emerald-100/50 hover:border-emerald-200 text-emerald-800 font-bold py-4 px-6 rounded-2xl flex items-center justify-between group transition-all duration-300 hover:shadow-md"
                      >
                        <div className="flex items-center gap-4">
                          <div className="bg-white p-2.5 rounded-xl text-emerald-500 shadow-sm ring-1 ring-emerald-50">
                            <Star size={24} fill="currentColor" />
                          </div>
                          <div className="text-left">
                            <div className="text-xs text-emerald-600/70 font-medium mb-0.5">입문자용</div>
                            <div className="text-lg tracking-tight">쉬움 (Easy)</div>
                          </div>
                        </div>
                        <ChevronRight className="text-emerald-300 group-hover:translate-x-1 transition-transform" />
                      </button>

                      <button 
                        onClick={() => onStart('difficulty', 'hard')}
                        className="w-full bg-white hover:bg-gray-50 border border-gray-200 hover:border-gray-300 text-gray-700 font-bold py-4 px-6 rounded-2xl flex items-center justify-between group transition-all duration-300 hover:shadow-md"
                      >
                        <div className="flex items-center gap-4">
                           <div className="bg-gray-100 p-2.5 rounded-xl text-gray-400 shadow-sm">
                            <BookOpen size={24} />
                          </div>
                          <div className="text-left">
                            <div className="text-xs text-gray-400 font-medium mb-0.5">숙련자용</div>
                            <div className="text-lg tracking-tight">어려움 (Hard)</div>
                          </div>
                        </div>
                        <ChevronRight className="text-gray-300 group-hover:translate-x-1 transition-transform" />
                      </button>
                    </>
                  ) : (
                    // 주제별(모듈) 선택 버튼
                    <>
                      {Object.entries(MODULES).map(([key, info]) => (
                        <button 
                          key={key}
                          onClick={() => onStart('module', key)}
                          className="w-full bg-white hover:bg-teal-50 border border-gray-200 hover:border-teal-200 text-gray-700 hover:text-teal-800 font-bold py-3.5 px-5 rounded-2xl flex items-center justify-between group transition-all duration-300 hover:shadow-md"
                        >
                          <div className="flex items-center gap-4">
                            <div className="bg-teal-50/80 p-2.5 rounded-xl text-teal-600 group-hover:bg-white group-hover:text-teal-500 transition-colors shadow-sm">
                              {info.icon}
                            </div>
                            <div className="text-left">
                              <div className="text-base tracking-tight">{info.title}</div>
                              <div className="text-xs text-gray-400 font-normal group-hover:text-teal-600/70">{info.desc}</div>
                            </div>
                          </div>
                          <ChevronRight size={20} className="text-gray-300 group-hover:text-teal-400 group-hover:translate-x-1 transition-transform" />
                        </button>
                      ))}
                    </>
                  )}
                </div>
              </div>
            </div>
          );
        };

        const CompletionScreen = ({ modeInfo, onRestart, onHome }) => {
          return (
            <div className="flex flex-col items-center justify-center min-h-[60vh] px-4 animate-fade-in text-center">
              <div className="bg-white p-10 rounded-3xl shadow-2xl border border-emerald-100 max-w-md w-full">
                <div className="mb-8 relative">
                  <div className="absolute inset-0 bg-yellow-100 rounded-full scale-125 opacity-30 animate-pulse"></div>
                  <Award className="w-24 h-24 text-yellow-500 mx-auto relative z-10 drop-shadow-lg" />
                </div>
                
                <h2 className="text-3xl font-bold text-gray-800 mb-3 tracking-tight">학습 완료!</h2>
                <p className="text-gray-600 mb-10 leading-relaxed">
                  <span className="font-bold text-emerald-600 border-b border-emerald-200 pb-0.5">{modeInfo}</span> 과정을<br/>
                  성공적으로 마쳤습니다.
                </p>

                <div className="flex gap-3">
                  <button 
                    onClick={onHome}
                    className="flex-1 bg-gray-50 hover:bg-gray-100 border border-gray-200 text-gray-600 font-bold py-3.5 px-4 rounded-xl flex items-center justify-center gap-2 transition-all"
                  >
                    <Home size={18} /> 홈으로
                  </button>
                  <button 
                    onClick={onRestart}
                    className="flex-1 bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3.5 px-4 rounded-xl flex items-center justify-center gap-2 shadow-lg shadow-emerald-200 transition-all hover:-translate-y-0.5"
                  >
                    <RotateCcw size={18} /> 다시하기
                  </button>
                </div>
              </div>
            </div>
          );
        };

        const Header = ({ onHome, currentMode, modeLabel }) => (
          <header className="bg-gradient-to-r from-emerald-700 via-teal-700 to-teal-600 text-white p-4 shadow-lg sticky top-0 z-50 backdrop-blur-md bg-opacity-95">
            <div className="max-w-4xl mx-auto flex justify-between items-center">
              <div 
                className="text-left flex items-center gap-3 cursor-pointer hover:opacity-90 transition-opacity group"
                onClick={onHome}
              >
                <div className="bg-white/10 p-2 rounded-xl backdrop-blur-sm border border-white/10 group-hover:bg-white/20 transition-colors">
                  <HeartHandshake className="w-6 h-6 text-emerald-50" />
                </div>
                <div>
                  <h1 className="text-lg font-bold leading-tight tracking-wide font-sans">SVP-PREP</h1>
                </div>
              </div>
              
              {currentMode && (
                <div className="flex items-center gap-3">
                  <span className="px-3 py-1 rounded-full text-xs font-bold border bg-white/10 border-white/20 text-white backdrop-blur-md shadow-sm">
                    {modeLabel}
                  </span>
                  <button 
                    onClick={onHome}
                    className="p-2 hover:bg-white/10 rounded-full transition-colors"
                    title="처음으로"
                  >
                    <Home size={20} className="text-emerald-50" />
                  </button>
                </div>
              )}
            </div>
          </header>
        );

        const ProgressBar = ({ current, total }) => {
          const percentage = Math.min(100, (current / total) * 100);
          return (
            <div className="w-full max-w-2xl mx-auto mb-6 px-4">
              <div className="flex justify-between text-xs font-semibold text-gray-400 mb-2">
                <span>Progress</span>
                <span>{current} / {total}</span>
              </div>
              <div className="h-2 w-full bg-gray-100 rounded-full overflow-hidden border border-gray-100">
                <div 
                  className="h-full bg-emerald-500 transition-all duration-700 ease-out rounded-full relative"
                  style={{ width: `${percentage}%` }}
                >
                    <div className="absolute top-0 right-0 bottom-0 w-full bg-gradient-to-b from-white/20 to-transparent"></div>
                </div>
              </div>
            </div>
          );
        };

        const Flashcard = ({ card, isFlipped, setIsFlipped, onNext, onPrev, currentIdx, totalCards, onShuffle }) => {
          const [showAnswer, setShowAnswer] = useState(false);

          useEffect(() => {
            if (!isFlipped) {
              const timer = setTimeout(() => setShowAnswer(false), 300);
              return () => clearTimeout(timer);
            }
          }, [isFlipped, card]);

          useEffect(() => {
            setShowAnswer(false);
          }, [card]);

          const handleReveal = (e) => {
            e.stopPropagation();
            setShowAnswer(true);
          };

          const isLastCard = currentIdx === totalCards - 1;

          // 난이도별 뱃지 스타일
          const difficultyStyle = card.difficulty === 'easy' 
            ? 'bg-amber-50 text-amber-700 border-amber-100' 
            : 'bg-indigo-50 text-indigo-700 border-indigo-100';

          return (
            <div className="flex flex-col items-center justify-center py-2 px-4 w-full max-w-2xl mx-auto">
              <ProgressBar current={currentIdx + 1} total={totalCards} />

              <div className="w-full flex justify-between items-center mb-4 px-2">
                <div className="flex items-center gap-2">
                   <span className={`px-2.5 py-1 rounded-lg border text-[10px] font-bold uppercase tracking-wider ${difficultyStyle}`}>
                     {card.difficulty}
                   </span>
                   <span className="bg-emerald-50 border border-emerald-100 text-emerald-700 px-3 py-1 rounded-lg text-xs font-bold tracking-tight">{card.category}</span>
                </div>
                <button 
                  onClick={onShuffle}
                  className="flex items-center gap-1.5 text-xs font-medium text-gray-400 hover:text-emerald-600 bg-white border border-gray-100 hover:border-emerald-200 px-3 py-1.5 rounded-full transition-colors shadow-sm"
                  title="현재 목록 섞기"
                >
                  <Shuffle size={14} /> 섞기
                </button>
              </div>
              
              <div 
                className="relative w-full h-[400px] perspective-1000 cursor-pointer group"
                onClick={() => setIsFlipped(!isFlipped)}
              >
                <div className={`relative w-full h-full duration-500 transform-style-3d transition-all ${isFlipped ? 'rotate-y-180' : ''}`}>
                  
                  {/* Front (문제) */}
                  <div className="absolute w-full h-full bg-white rounded-3xl shadow-[0_4px_20px_rgb(0,0,0,0.03)] border border-gray-100 p-8 flex flex-col items-center justify-center backface-hidden z-20 hover:border-emerald-200 transition-colors">
                    <div className="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-emerald-400 to-teal-400 rounded-t-3xl"></div>
                    
                    <div className={`p-4 rounded-2xl mb-8 shadow-sm ${card.difficulty === 'easy' ? 'bg-amber-50 text-amber-500' : 'bg-indigo-50 text-indigo-500'}`}>
                      <HelpCircle size={32} />
                    </div>
                    
                    <h3 className="text-xl md:text-2xl font-bold text-gray-800 text-center leading-relaxed break-keep tracking-tight">
                      {card.question}
                    </h3>
                    
                    <div className="absolute bottom-8 text-gray-300 text-sm flex items-center gap-2 animate-pulse font-medium">
                      <RefreshCw size={14} /> 탭하여 정답 확인
                    </div>
                  </div>

                  {/* Back (정답) */}
                  <div className="absolute w-full h-full bg-gradient-to-br from-emerald-600 to-teal-700 rounded-3xl shadow-[0_8px_30px_rgb(0,0,0,0.15)] p-8 flex flex-col items-center justify-center rotate-y-180 backface-hidden border border-emerald-500/50">
                    {!showAnswer ? (
                      <div className="flex flex-col items-center justify-center w-full h-full space-y-8">
                        {card.hint && (
                          <div 
                            onClick={handleReveal}
                            className="w-full bg-white/10 backdrop-blur-md border border-white/20 rounded-2xl p-6 cursor-pointer hover:bg-white/20 transition-all group/hint"
                          >
                            <p className="text-emerald-200 text-xs font-bold mb-3 text-center tracking-widest opacity-80 group-hover/hint:opacity-100">HINT</p>
                            <p className="text-white text-center text-sm font-medium leading-relaxed">{card.hint}</p>
                          </div>
                        )}
                        
                        <button 
                          onClick={handleReveal}
                          className="bg-white text-emerald-800 px-8 py-3.5 rounded-full font-bold shadow-xl hover:bg-emerald-50 hover:scale-105 transition-all flex items-center gap-2.5"
                        >
                          <Eye size={20} /> 정답 보기
                        </button>
                      </div>
                    ) : (
                      <div className="flex flex-col items-center justify-center animate-fade-in w-full h-full overflow-y-auto custom-scrollbar">
                        <div className="bg-white/20 text-white p-3 rounded-full mb-6 backdrop-blur-sm border border-white/10">
                          <CheckCircle size={32} />
                        </div>
                        <h3 className="text-xl font-bold text-white text-center mb-8 leading-relaxed break-keep tracking-tight">
                          {card.answer}
                        </h3>
                        {card.hint && (
                          <div className="mt-auto bg-black/20 p-4 rounded-xl border border-white/10 w-full backdrop-blur-sm">
                            <p className="text-emerald-50 text-sm text-center leading-relaxed"><span className="font-bold opacity-75 text-emerald-200">💡 Hint:</span> {card.hint}</p>
                          </div>
                        )}
                      </div>
                    )}
                  </div>
                </div>
              </div>

              <div className="flex items-center justify-between w-full mt-8 px-2">
                <button 
                  onClick={(e) => { e.stopPropagation(); onPrev(); }}
                  className={`flex items-center gap-2 px-5 py-3 rounded-xl font-medium transition-all ${
                    currentIdx === 0 
                      ? 'bg-gray-50 text-gray-300 cursor-not-allowed' 
                      : 'bg-white border border-gray-200 text-gray-600 hover:bg-gray-50 hover:border-gray-300 shadow-sm'
                  }`}
                  disabled={currentIdx === 0}
                >
                  <ChevronLeft size={20} /> 이전
                </button>
                
                <button 
                  onClick={(e) => { e.stopPropagation(); onNext(); }}
                  className={`flex items-center gap-2 px-6 py-3 rounded-xl font-bold text-white shadow-md transition-all hover:-translate-y-0.5 ${
                    isLastCard 
                     ? 'bg-emerald-600 hover:bg-emerald-700 shadow-emerald-200' 
                     : 'bg-gray-800 hover:bg-gray-900'
                  }`}
                >
                  {isLastCard ? '학습 완료' : '다음 문제'} <ChevronRight size={20} />
                </button>
              </div>
            </div>
          );
        };

        const SVPPreventionApp = () => {
          const [gameStep, setGameStep] = useState('intro'); // 'intro' | 'playing' | 'completed'
          const [filterState, setFilterState] = useState(null);
          const [currentCardIdx, setCurrentCardIdx] = useState(0);
          const [isFlipped, setIsFlipped] = useState(false);
          const [cards, setCards] = useState([]);

          // 필터링 및 셔플 로직
          const getFilteredCards = (type, value) => {
            let filtered = [];
            if (type === 'difficulty') {
              filtered = originalFlashcards.filter(card => card.difficulty === value);
            } else if (type === 'module') {
              filtered = originalFlashcards.filter(card => card.module === value);
            }
            
            // 셔플
            const shuffled = [...filtered];
            for (let i = shuffled.length - 1; i > 0; i--) {
              const j = Math.floor(Math.random() * (i + 1));
              [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            
            // 20개로 제한
            return shuffled.slice(0, 20);
          };

          const startGame = (type, value) => {
            setFilterState({ type, value });
            setCards(getFilteredCards(type, value));
            setCurrentCardIdx(0);
            setIsFlipped(false);
            setGameStep('playing');
          };

          const goHome = () => {
            setGameStep('intro');
            setFilterState(null);
            setCards([]);
          };
          
          const restartGame = () => {
             setCards(getFilteredCards(filterState.type, filterState.value));
             setCurrentCardIdx(0);
             setIsFlipped(false);
             setGameStep('playing');
          };

          const handleManualShuffle = () => {
            setIsFlipped(false);
            setTimeout(() => {
              const newCards = getFilteredCards(filterState.type, filterState.value);
              setCards(newCards);
              setCurrentCardIdx(0);
            }, 200);
          };

          const nextCard = () => {
            if (cards.length === 0) return;
            
            if (currentCardIdx === cards.length - 1) {
                setGameStep('completed');
                return;
            }

            setIsFlipped(false);
            setTimeout(() => {
              setCurrentCardIdx((prev) => prev + 1);
            }, 200);
          };

          const prevCard = () => {
            if (cards.length === 0 || currentCardIdx === 0) return;
            setIsFlipped(false);
            setTimeout(() => {
              setCurrentCardIdx((prev) => prev - 1);
            }, 200);
          };

          const getModeLabel = () => {
            if (!filterState) return "";
            if (filterState.type === 'difficulty') {
              return filterState.value === 'easy' ? 'Easy (쉬움)' : 'Hard (어려움)';
            } else {
              return MODULES[filterState.value]?.title || '주제별 학습';
            }
          };

          return (
            <div className="min-h-screen bg-slate-50 font-sans text-gray-900">
              <Header 
                onHome={goHome} 
                currentMode={gameStep !== 'intro'} 
                modeLabel={getModeLabel()} 
              />

              <main className="py-6 flex flex-col items-center justify-center min-h-[calc(100vh-80px)] w-full">
                {gameStep === 'intro' && (
                  <IntroScreen onStart={startGame} />
                )}

                {gameStep === 'playing' && (
                  <div className="flex flex-col items-center w-full animate-fade-in">
                    {cards.length > 0 ? (
                      <Flashcard 
                        card={cards[currentCardIdx]} 
                        isFlipped={isFlipped} 
                        setIsFlipped={setIsFlipped}
                        onNext={nextCard}
                        onPrev={prevCard}
                        onShuffle={handleManualShuffle}
                        currentIdx={currentCardIdx}
                        totalCards={cards.length}
                      />
                    ) : (
                      <div className="text-center p-8 text-gray-500">
                        <RefreshCw className="animate-spin w-8 h-8 mx-auto mb-2 text-emerald-600" />
                        <p>해당 주제의 문제가 준비 중입니다.</p>
                        <button onClick={goHome} className="mt-4 text-emerald-600 underline font-medium">돌아가기</button>
                      </div>
                    )}
                  </div>
                )}

                {gameStep === 'completed' && (
                    <CompletionScreen 
                        modeInfo={getModeLabel()} 
                        onRestart={restartGame} 
                        onHome={goHome} 
                    />
                )}
              </main>
              
              <footer className="bg-white border-t border-gray-100 py-6 text-center text-xs text-gray-400 w-full mt-auto">
                <p className="font-medium text-gray-500">© 2025 SVP-PREP Program.</p>
                <p className="mt-1">환자안전사건을 마주할 수 있는 모든 간호사를 응원합니다.</p>
              </footer>
            </div>
          );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<SVPPreventionApp />);
    </script>
</body>
</html>
